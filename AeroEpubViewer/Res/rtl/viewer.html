<html>
<head>
    <title>Viewer/rtl</title>
    <style>
        iframe {
            position: fixed;
            overflow: hidden;
        }

        #nav {
            position: fixed;
            height: 95vh;
            left: 0;
            top: 0;
            z-index: 10;
            background: white;
            border: solid 1px;
        }

        navLabel {
            width: 100%;
            height: 2em;
            display: block;
            left: 0;
        }

            navLabel:hover {
                background: #808080;
                cursor: pointer;
            }
    </style>
</head>
<body>
    <div id="nav"></div>
    <script>
        var direction_rtl = new Object();
        direction_rtl.GetFrameLength = function (e) { return e.offsetWidth; }
        direction_rtl.GetWindowLength = function () { return window.innerWidth; }
        direction_rtl.AdjustFrameSize = function (f) { f.width = f.contentWindow.document.body.scrollWidth + "px"; }
        direction_rtl.SetPosStyle = function (e) { e.style.right = e.pos + "px"; }
        direction_rtl.style = "iframe{height:90vh;top:0;}";
        var direction_default = new Object();
        direction_default.GetFrameLength = function (e) { return e.offsetHeight; }
        direction_default.GetWindowLength = function () { return window.innerHeight; }
        direction_default.AdjustFrameSize = function (f) { f.height = f.contentWindow.document.body.scrollHeight + "px"; }
        direction_default.SetPosStyle = function (e) { e.style.top = e.pos + "px"; }
        direction_default.style = "iframe{width:90vw;right:0;}";

        var direction = direction_default;





        var frameList = new Array();
        var urlList;
        function Init(_urlList, start = 0) {
            var style = document.createElement('style');
            style.innerHTML = direction.style;
            document.head.appendChild(style);
            urlList = _urlList;
            window.onmousewheel = function (e) {
                document.Scroll(Math.sign(e.wheelDelta) * 40);
            }


            let page = CreateFrame(start, 0, CheckLoad);
            frameList.push(page);

            document.Scroll = Scroll;

        }
        function LoadToc(data, path) {
            let nav = document.getElementById("nav");
            nav.innerHTML = data;
            let navPionts = nav.getElementsByTagName("navPoint");
            [].forEach.call(navPionts, function (p) {
                let label = p.getElementsByTagName("navLabel")[0];
                let content = p.getElementsByTagName("content")[0];
                label.onclick = function () {
                    Link(path + "/" + content.getAttribute("src"));
                }
            });
        }
        function Link(url) {
            let fullurl = "aeroepub://" + ("book/" + url).replace("//", "/");
            let path = fullurl.split('#')[0];
            console.log(fullurl);
            for (var i = 0; i < urlList.length; i++) {

                if (urlList[i] == path) { DirectToIndex(i); return; }

            }
        }
        function DirectToIndex(urlIndex) {
            frameList.forEach(e => e.parentNode.removeChild(e));
            frameList = new Array();
            Init(urlList, urlIndex);

        }
        function CreateFrame(urlIndex, pos, check = null, addSelfLength = false) {
            loading = true;
            console.log("Create Frame " + urlList[urlIndex] + " pos:" + pos + " addSelf:" + addSelfLength);
            let page = document.createElement("iframe");
            //private use
            page.pos = pos;
            page.urlIndex = urlIndex;
            page.style.visibility = "hidden";
            if (urlIndex == 0) page.firstFrame = true; else page.firstFrame = false;
            if (urlIndex == urlList.length - 1) page.lastFrame = true; else page.lastFrame = false;

            page.scrolling = "no";
            page.frameBorder = "0";
            page.src = urlList[urlIndex];
            direction.SetPosStyle(page);
            page.onload = function () {
                direction.AdjustFrameSize(page);
                if (addSelfLength) {

                    page.pos = pos - direction.GetFrameLength(page);
                    direction.SetPosStyle(page);
                } else {
                    page.pos = pos;
                    direction.SetPosStyle(page);
                }
                loading = false;
                page.style.visibility = "visible";
                console.log(frameList[0].pos);
                if (check != null) check();
            }
            document.body.appendChild(page);
            return page;
        }
        function Scroll(px) {
            if (frameList[0].firstFrame && px > 0) {
                if (frameList[0].pos + px > 0) { px = - frameList[0].pos; }
            }
            let last = frameList[frameList.length - 1];
            if (last.lastFrame && px < 0) {
                if (last.pos + direction.GetFrameLength(last) + px < direction.GetWindowLength()) { px = direction.GetWindowLength() - last.pos - direction.GetFrameLength(last); }
            }
            frameList.forEach((e) => {
                e.pos += px;
                direction.SetPosStyle(e);
            });
            if (!loading) CheckLoad();
        }
        var loading = false;
        var offScreenDestoryDistance = 50;
        var preLoadDistance = 50;
        var checking = false;
        function CheckLoad() {
            if (checking) return;
            checking = true;
            CheckForward();
            CheckBackward();
            checking = false;
        }
        function CheckBackward() {
            let first = frameList[0];
            if (-first.pos < preLoadDistance) {
                if (!first.firstFrame) {
                    frameList.unshift(CreateFrame(first.urlIndex - 1, first.pos, CheckBackward, true));
                }
            }

            if (first.pos + direction.GetFrameLength(first) < offScreenDestoryDistance) {
                first.parentNode.removeChild(first);
                frameList.shift();
            }
        }
        function CheckForward() {
            let last = frameList[frameList.length - 1];
            if (last.pos + direction.GetFrameLength(last) < direction.GetWindowLength() + preLoadDistance) {

                if (!last.lastFrame) {
                    frameList.push(CreateFrame(last.urlIndex + 1, last.pos + direction.GetFrameLength(last), CheckForward));
                }
            }

            if (last.pos > direction.GetWindowLength() + offScreenDestoryDistance) {
                last.parentNode.removeChild(last);
                frameList.pop();
                CheckLoad();
            }
        }




    </script>
</body>

</html>