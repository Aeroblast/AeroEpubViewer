<html>
<head>
    <title>Viewer</title>
    <style>
        body {
            overflow: hidden;
        }

        iframe {
            position: fixed;
            overflow: hidden;
            z-index: 5;
        }

        #navSwitch {
            position: fixed;
            height: 10vh;
            width: 10vw;
            left: 0;
            top: 0;
            background: transparent;
            z-index: 11;
            cursor: pointer;
        }

        #nav {
            position: fixed;
            height: 0vh;
            left: 0;
            top: 0;
            z-index: 10;
            background: transparent;
            overflow: hidden;
            padding-left: 2vw;
            padding-right: 2vw;
        }

            #nav > navpoint:nth-child(1) > navLabel {
                margin-top: 10vh;
            }

        #menu {
            position: fixed;
            width: 100%;
            height: 0vh;
            left: 0;
            top: 0;
            z-index: 10;
            overflow: hidden;
        }

            #menu > div {
                height: 10vh;
                display: inline-block;
                text-align: center;
                line-height: 10vh;
                border-right: solid 1px;
                overflow: hidden;
            }

                #menu > div > div {
                    height: 6vh;
                    margin-top: 2vh;
                    margin-right: 2px;
                    display: inline-block;
                    text-align: center;
                    overflow: hidden;
                    line-height: 6vh;
                }

        #nav::-webkit-scrollbar {
            display: none;
        }

        @keyframes navDisplay {
            from {
                height: 0vh;
                overflow: hidden;
                opacity: 0;
            }

            to {
                height: 89vh;
                overflow: scroll;
                opacity: 1;
            }
        }

        @keyframes navHide {

            from {
                height: 89vh;
                overflow: scroll;
                opacity: 1;
            }

            to {
                height: 0vh;
                overflow: hidden;
                opacity: 0;
            }
        }

        @keyframes menuDisplay {
            from {
                height: 0vh;
                opacity: 0;
            }

            to {
                height: 10vh;
                opacity: 1;
            }
        }

        @keyframes menuHide {

            from {
                height: 10vh;
                opacity: 1;
            }

            to {
                height: 0vh;
                opacity: 0;
            }
        }

        navLabel {
            width: 100%;
            height: 2em;
            display: block;
            left: 0;
        }
        content>navPoint>navLabel {
        padding-left:1em;
        }

            navLabel:hover {
                background: #808080;
                cursor: pointer;
            }

        .popupFootnote {
            width: 40vw;
            position: fixed;
            z-index: 40;
            border: solid 1px;
            background: white;
            min-height: 0;
        }

        #scrollBar {
            position: fixed;
            z-index: 15;
            opacity: 0.0;
        }

            #scrollBar:hover {
                opacity: 1;
            }
    </style>
</head>
<body>
    <div id="screenTest" style="width:100vw;height:100vh;visibility:hidden;z-index:-99"></div>

    <div id="navSwitch" onclick="NavSwitch()"></div>
    <div id="menu">

        <div id="navSwitchDummy" style="width:10vw;background:transparent;">TOC</div>
        <div style="border-right:solid 1px;">
            <div><input id="fontSizeInput" style="width:3em" type="number" />px</div>
            <div onclick="ApplyFontSize(document.getElementById('fontSizeInput').value)" style="cursor:pointer;background:white;font-size:0.7em">字号生效</div>
        </div>
        <div><div style="cursor:pointer;" onclick="Inspector()">检查</div></div>
        <div>
            <div style="top:3vh;line-height:1.2em;">
                Theme:　<br /><select id="themeSelect" onchange="SetTheme()">
                    <option value="default" selected>Default</option>
                    <option value="warm">Warm</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>




    </div>
    <div id="nav" style=""></div>
    <div id="mouseListener" style="position:fixed;z-index:1;width:100vw;height:100vh;left:0;top:0;"></div>
    <script>
        ScreenTest();

        var direction_rtl = new Object();
        direction_rtl.GetFrameLength = function (e) { return e.offsetWidth; }
        direction_rtl.GetWindowLength = function () { return window.innerWidth; }
        direction_rtl.AdjustFrameSize = function (f) { f.width = f.contentWindow.document.documentElement.scrollWidth + "px"; }
        direction_rtl.SetPosStyle = function (e) { e.style.right = e.pos + "px"; }
        direction_rtl.style = "iframe{height:90vh;top:2vh;}#scrollBar{width:100vw;left:0;bottom:0;margin:0;transform-origin: 50vw 0;transform: rotate(180deg);}";
        direction_rtl.injectStyle = "body{height:100vh;min-width:66vh;}";
        direction_rtl.GetEffective = function (x, y) { return x; };
        direction_rtl.GetDelta = function (d1, d2) { return d1 - d2; };
        direction_rtl.KeyToDirection = function (k) {
            switch (k) {
                case "ArrowLeft": return -1;
                case "ArrowUp": return 1;
                case "ArrowRight": return 1;
                case "ArrowDown": return -1;
            }
            return 0;
        }
        var direction_default = new Object();
        direction_default.GetFrameLength = function (e) { return e.offsetHeight; }
        direction_default.GetWindowLength = function () { return window.innerHeight; }
        direction_default.AdjustFrameSize = function (f) { f.height = f.contentWindow.document.documentElement.scrollHeight + "px"; }
        direction_default.SetPosStyle = function (e) { e.style.top = e.pos + "px"; }
        direction_default.style = "iframe{width:95vw;left:2.5vw;min-height:90vh;} #scrollBar{-webkit-appearance: slider-vertical;margin:0;width:2.5vw;height:100vh;top:0;right:0;transform-origin: 1.25vw 50vh;transform: rotate(180deg);}";
        direction_default.injectStyle = "body{width:100vw;padding-bottom:3vh;}";
        direction_default.GetEffective = function (x, y) { return y; };
        direction_default.GetDelta = function (d1, d2) { return d2 - d1; };
        direction_default.KeyToDirection = function (k) {
            switch (k) {
                case "ArrowUp": return 1;
                case "ArrowDown": return -1;
            }
            return 0;
        }
        var theme_default = new Object();
        theme_default.name = "default";
        theme_default.viewerStyle = "#nav,#menu{background:white;color:black;}";
        theme_default.frameStyle = "body{background:white;color:black;}";
        var theme_warm = new Object();
        theme_warm.name = "warm";
        theme_warm.viewerStyle = "body,#nav,#menu{background:#ffe6a0;color:black;}";
        theme_warm.frameStyle = "body{background:#ffe6a0;color:black;}";
        var theme_dark = new Object();
        theme_dark.name = "dark";
        theme_dark.viewerStyle = "body,#nav,#menu{background:black;color:white;}";
        theme_dark.frameStyle = "body{background:black;color:white;}";

        document.theme = theme_default;
        var themeStyle = document.createElement("style");
        document.head.appendChild(themeStyle);
        var direction = direction_default;
        var frameList = new Array();
        var urlList;
        function Init(_urlList, start = 0, posRate = 0) {
            document.direction = direction;
            console.log("Init start=" + start + " pos=" + posRate + "");
            var style = document.createElement('style');
            style.innerHTML = direction.style;
            document.head.appendChild(style);
            urlList = _urlList;
            document.getElementById("mouseListener").onmousewheel = function (e) {
                document.Scroll(Math.sign(e.wheelDelta) * 40);
            }
            document.keydown = function (e) {
                let d = direction.KeyToDirection(e.key);
                Scroll(d * 30);
            };
            //document.addEventListener("mouseup", MenuSwitch);
            document.MenuSwitch = MenuSwitch;
            document.addEventListener("keydown", document.keydown);
            var PrepareResize = function () {
                window.removeEventListener("resize", PrepareResize)
                var xhttp = new XMLHttpRequest();
                xhttp.open("GET", "aeroepub://app/pos" + GetBookPos(), true);
                xhttp.send();
            };
            window.addEventListener("resize", PrepareResize);


            let page = CreateFrame(start, posRate, CheckLoad, false, true);
            frameList.push(page);

        }

        function LoadToc(data, path) {
            let nav = document.getElementById("nav");
            nav.innerHTML = data;
            let navPionts = nav.getElementsByTagName("navPoint");
            [].forEach.call(navPionts, function (p) {
                let label = p.getElementsByTagName("navLabel")[0];
                let content = p.getElementsByTagName("content")[0];
                label.onclick = function () {
                    Link(path + "/" + content.getAttribute("src"));
                    NavSwitch();
                }
            });
        }
        function LoadUserSettings(json) {
            document.userSettings = json;
            document.getElementById("fontSizeInput").value = json.bookFontSize;
            document.getElementById("themeSelect").value = json.viewerTheme;
            SetTheme();
        }
        var contentLengthData;
        var scrollBar;
        function LoadScrollBar(arr) {
            contentLengthData = arr;
            let total = 0;
            for (let i = 0; i < contentLengthData.length; i++)
                total += contentLengthData[i];
            scrollBar = document.createElement("input");
            scrollBar.id = "scrollBar";
            scrollBar.type = "range";
            scrollBar.min = 0;
            scrollBar.max = total;
            scrollBar.step = 1;
            scrollBar.oninput = function () {
            };
            scrollBar.onchange = function () {
                let v = scrollBar.value;
                let s = 0;
                for (let i = 0; i < contentLengthData.length; i++) {
                    s += contentLengthData[i];
                    if (s > v) {
                        let rate = (v - s + contentLengthData[i]) / contentLengthData[i];
                        frameList.forEach(e => e.parentNode.removeChild(e));
                        frameList = new Array();
                        Init(urlList, i, rate);
                        return;
                    }
                }
            };
            document.body.appendChild(scrollBar);

        }
        function SetScrollBar() {
            let v = 0;
            let i = 0;
            for (; i < currentFrame.urlIndex; i++)
                v += contentLengthData[i];

            v += (-currentFrame.pos) * contentLengthData[i] / direction.GetFrameLength(currentFrame);//i是urlIndex

            scrollBar.value = v;
        }
        document.Link = Link;
        function Link(url) {
            let fullurl = url;
            if (url.indexOf("aeroepub") != 0)
                fullurl = "aeroepub://" + ("book/" + url).replace("//", "/");

            let path = fullurl.split('#')[0];
            console.log("Linkto:" + fullurl);
            for (var i = 0; i < urlList.length; i++) {

                if (urlList[i] == path) { DirectToIndex(i); return; }

            }
            console.log("Cannot link to " + url);
        }
        function DirectToIndex(urlIndex) {
            frameList.forEach(e => e.parentNode.removeChild(e));
            frameList = new Array();
            Init(urlList, urlIndex);
        }
        function CreateFrame(urlIndex, pos, check = null, addSelfLength = false, isPosRate = false) {
            loading = true;
            console.log("Create Frame " + urlList[urlIndex] + (isPosRate ? " posRate:" : " pos:") + pos + " addSelf:" + addSelfLength);
            let page = document.createElement("iframe");
            //private use
            page.pos = pos;
            page.urlIndex = urlIndex;
            page.style.visibility = "hidden";
            if (urlIndex == 0) page.firstFrame = true; else page.firstFrame = false;
            if (urlIndex == urlList.length - 1) page.lastFrame = true; else page.lastFrame = false;

            page.scrolling = "no";
            page.frameBorder = "0";
            page.src = urlList[urlIndex];
            direction.SetPosStyle(page);
            page.onload = function () {
                direction.AdjustFrameSize(page);

                if (addSelfLength) {

                    page.pos = pos - direction.GetFrameLength(page);
                    direction.SetPosStyle(page);
                } else {
                    if (isPosRate) {
                        page.pos = -parseInt(pos * direction.GetFrameLength(page));
                        console.log(pos + " -> " + page.pos + "px");

                    } else {
                        page.pos = pos;
                    }
                    direction.SetPosStyle(page);
                }
                loading = false;
                page.style.visibility = "visible";
                if (check != null) check();
                Scroll(0);
                SetScrollBar();
                page.onload = null;
            }
            document.body.appendChild(page);
            return page;
        }
        var currentFrame = null;
        function GetBookPos() {
            if (currentFrame == null) return "/0";
            return "/" + currentFrame.urlIndex + "/" + currentFrame.pos + "/" + (direction.GetFrameLength(currentFrame));
        }
        document.Scroll = Scroll;
        function Scroll(px) {
            if (frameList[0].firstFrame && px > 0) {
                if (frameList[0].pos + px > 0) { px = - frameList[0].pos; }
            }
            let last = frameList[frameList.length - 1];
            if (last.lastFrame && px < 0) {
                if (last.pos + direction.GetFrameLength(last) + px < direction.GetWindowLength()) { px = direction.GetWindowLength() - last.pos - direction.GetFrameLength(last); }
            }
            currentFrame = frameList[0];
            let lastPos = px + frameList[0].pos;
            for (let i = 0; i < frameList.length; i++) {
                let e = frameList[i];
                e.pos = lastPos;
                direction.SetPosStyle(e);
                if (e.pos < 0 && e.pos + direction.GetFrameLength(e) > 0) { currentFrame = e; }
                lastPos = e.pos + direction.GetFrameLength(e);
            }
            if (!loading) CheckLoad();
            SetScrollBar();
        }
        var loading = false;
        var offScreenDestoryDistance = 50;
        var preLoadDistance = 50;
        var checking = false;
        function CheckLoad() {
            if (checking) return;
            checking = true;
            CheckForward();
            CheckBackward();
            checking = false;
        }
        function CheckBackward() {
            let first = frameList[0];
            if (-first.pos < preLoadDistance) {
                if (!first.firstFrame) {
                    frameList.unshift(CreateFrame(first.urlIndex - 1, first.pos, CheckBackward, true));
                }
            }

            if (first.pos + direction.GetFrameLength(first) < -offScreenDestoryDistance) {
                first.parentNode.removeChild(first);
                frameList.shift();
            }
        }
        function CheckForward() {
            let last = frameList[frameList.length - 1];
            if (last.pos + direction.GetFrameLength(last) < direction.GetWindowLength() + preLoadDistance) {

                if (!last.lastFrame) {
                    frameList.push(CreateFrame(last.urlIndex + 1, last.pos + direction.GetFrameLength(last), CheckForward));
                }
            }

            if (last.pos > direction.GetWindowLength() + offScreenDestoryDistance) {
                last.parentNode.removeChild(last);
                frameList.pop();
                CheckLoad();
            }
        }
        function ScreenTest() {
            let e = document.getElementById("screenTest");
            let xhttp = null
            xhttp = new XMLHttpRequest();
            xhttp.open("GET", "aeroepub://app/screentest/" + e.offsetWidth + "/" + e.offsetHeight, true);
            xhttp.send();
        }
        /// UI
        var nav = document.getElementById("nav");
        var navOn = false;
        function NavSwitch() {
            if (navOn) {
                navOn = false;
                nav.style.animation = "navHide 0.5s ease 0s 1 ";

            } else {
                navOn = true;
                nav.style.animation = "navDisplay 0.5s ease 0s 1";

            }
            nav.style.animationFillMode = "forwards";

        }
        var menuOn = false;
        var menu = document.getElementById("menu");
        function MenuSwitch() {
            if (menuOn) {
                menuOn = false;
                menu.style.animation = "menuHide 0.5s ease 0s 1 ";

            } else {
                menuOn = true;
                menu.style.animation = "menuDisplay 0.5s ease 0s 1";

            }
            menu.style.animationFillMode = "forwards";
        }

        function ApplyFontSize(a) {
            document.userSettings.bookFontSize = parseInt(a);
            let xhttp = null
            xhttp = new XMLHttpRequest();
            xhttp.open("GET", "aeroepub://app/pos" + GetBookPos(), true);
            xhttp.send();
            xhttp = new XMLHttpRequest();
            xhttp.open("GET", "aeroepub://app/bookfontsize/" + document.userSettings.bookFontSize, true);
            xhttp.send();
        }
        function Inspector() {
            let xhttp = null
            xhttp = new XMLHttpRequest();
            xhttp.open("GET", "aeroepub://app/inspector" + GetBookPos(), true);
            xhttp.send();
        }
        var popupFootnote = null;
        document.PopupFootnote = function (content, left, top, frame) {
            if (popupFootnote != null) popupFootnote.parentNode.removeChild(popupFootnote);
            popupFootnote = document.createElement("div");
            popupFootnote.className = "popupFootnote";
            console.log(frame);
            document.body.appendChild(popupFootnote);
            left = frame.offsetLeft + left
            top = frame.offsetTop + top + 20;

            popupFootnote.innerHTML = content;
            if (left + popupFootnote.offsetWidth > window.innerWidth) {
                left = window.innerWidth - popupFootnote.offsetWidth;
            }
            console.log(top);
            if (top + popupFootnote.offsetHeight > window.innerHeight) {

                top = window.innerHeight - popupFootnote.offsetHeight;

            }
            popupFootnote.style.left = left + "px";
            popupFootnote.style.top = top + "px";
        }
        var PopupFootnote2 = function (content, left, top, frame) {
            if (popupFootnote != null) popupFootnote.parentNode.removeChild(popupFootnote);
            popupFootnote = document.createElement("iframe");
            popupFootnote.className = "popupFootnote";
            popupFootnote.sandbox = "";
            popupFootnote.src = frame.src + "?footnote";
            document.body.appendChild(popupFootnote);
            left = frame.offsetLeft + left
            top = frame.offsetTop + top + 20;

            popupFootnote.onload = function () {
                popupFootnote.contentWindow.document.documentElement.innerHTML = frame.contentWindow.document.head.outerHTML + "<body>" + content + "</body>";
                if (left + popupFootnote.offsetWidth > window.innerWidth) {
                    left = window.innerWidth - popupFootnote.offsetWidth;
                }
                if (top + popupFootnote.offsetHeight > window.innerHeight) {
                    top = window.innerHeight - popupFootnote.offsetHeight;
                }
                popupFootnote.style.left = left + "px";
                popupFootnote.style.top = top + "px";
            }


        }
        document.PopupFootnote = PopupFootnote2;
        document.FrameMouseUp = function () {

            if (popupFootnote != null) {
                popupFootnote.parentNode.removeChild(popupFootnote);
                popupFootnote = null;
                return;
            }
            MenuSwitch();
        }

        var touchPos = -1;
        document.OnFrameTouchStart = function (x, y) {
            touchPos = direction.GetEffective(x, y);
        };
        document.OnFrameTouchMove = function (x, y) {
            let d = direction.GetEffective(x, y);
            let delta = direction.GetDelta(touchPos, d);
            Scroll(delta);
            touchPos = d;
        };
        document.OnFrameTouchEnd = function () {
            touchPos = -1;
        };
        function SetTheme()
        {
            let name = document.getElementById("themeSelect").value;
            switch (name) { case "default": document.theme = theme_default; break; case "warm": document.theme = theme_warm; break; case "dark": document.theme = theme_dark; break; }
            for (let i = 0; i < frameList.length; i++) { frameList[i].contentWindow.location.reload(); }
            themeStyle.innerHTML = document.theme.viewerStyle;
        }
    </script>
</body>

</html>