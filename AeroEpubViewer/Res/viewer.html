<html>
<head>
    <title>Viewer</title>
    <style>
        body {
            overflow: hidden;
        }

        iframe {
            position: fixed;
            overflow: hidden;
            z-index: 5;
        }

        #menu {
            position: fixed;
            width: 100%;
            height: 0vh;
            left: 0;
            top: 0;
            z-index: 20;
            overflow: hidden;
        }

            #menu > div {
                height: 10vh;
                display: inline-block;
                text-align: center;
                line-height: 10vh;
                border-right: solid 1px;
                overflow: hidden;
            }

                #menu > div > div {
                    height: 6vh;
                    margin-top: 2vh;
                    margin-right: 2px;
                    display: inline-block;
                    text-align: center;
                    overflow: hidden;
                    line-height: 6vh;
                }

        #navSwitch {
            position: fixed;
            height: 10vh;
            width: 10vw;
            left: 0;
            top: 0;
            background: transparent;
            z-index: 21; /*over 'menu'*/
            cursor: pointer;
        }

        #nav {
            position: fixed;
            height: 0vh;
            left: 0;
            top: 0;
            z-index: 10;
            background: transparent;
            overflow: hidden;
            padding-left: 2vw;
            padding-right: 2vw;
        }

            #nav > navpoint:nth-child(1) > navLabel, #nav > nav:nth-child(1) {
                margin-top: 10vh;
            }

        li {
            margin-left: 0.5em;
            padding: 0;
            text-indent: 0;
        }

        #nav ol {
            list-style: none;
            margin-left: 0;
            padding: 0;
        }

        nav {
            margin-left: 0;
            display: block;
        }


        #nav::-webkit-scrollbar {
            display: none;
        }

        navLabel {
            width: 100%;
            height: 2em;
            display: block;
            left: 0;
        }

        content > navPoint > navLabel {
            padding-left: 1em;
        }

        navLabel:hover, #nav li:hover {
            background: #808080;
            cursor: pointer;
        }

        .sp_frame_container {
            display: none;
        }

        .sp_frame_close {
            position: fixed;
            z-index: 22;
            width: 100%;
            height: 5%;
            top: 0;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.3);
            text-align: center;
            color: red;
            font-weight: bold;
        }

            .sp_frame_close:hover {
                background: rgba(255, 255, 255, 0.8);
            }

        .sp_frame {
            border: none;
            margin: 0;
            z-index: 22;
            left: 0;
            position: fixed;
            width: 100%;
            height: 95%;
            top: 5%;
        }

        @keyframes navDisplay {
            from {
                height: 0vh;
                overflow: hidden;
                opacity: 0;
            }

            to {
                height: 89vh;
                overflow: scroll;
                opacity: 1;
            }
        }

        @keyframes navHide {

            from {
                height: 89vh;
                overflow: scroll;
                opacity: 1;
            }

            to {
                height: 0vh;
                overflow: hidden;
                opacity: 0;
            }
        }

        @keyframes menuDisplay {
            from {
                height: 0vh;
                opacity: 0;
            }

            to {
                height: 10vh;
                opacity: 1;
            }
        }

        @keyframes menuHide {

            from {
                height: 10vh;
                opacity: 1;
            }

            to {
                height: 0vh;
                opacity: 0;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .popupFootnote {
            width: 40vw;
            position: fixed;
            z-index: 40;
            border: solid 1px;
            background: white;
            min-height: 0;
        }

        #scrollBar_container {
            position: fixed;
            z-index: 21;
            opacity: 0;
        }

        #scrollBar {
            -webkit-appearance: none;
            background: transparent;
            z-index: 21;
        }

            #scrollBar::-webkit-slider-runnable-track {
                -webkit-appearance: none;
                background: rgba(200,200,200,0.3);
                border: none;
                border-radius: 3px;
            }

            #scrollBar::-webkit-slider-thumb {
                -webkit-appearance: none;
                background: rgba(200,200,200,1);
                border: none;
                border-radius: 3px;
            }

            #scrollBar:focus {
                outline: none;
            }

        .scrollBarChapterName {
            z-index: 10;
            white-space: nowrap;
            overflow: visible;
            border-radius: 3px;
        }

        .scrollBarChapterDisplay {
            position: fixed;
            z-index: -1;
            margin: 0;
            padding: 0;
            background: rgba(200,200,200,0.3);
        }

        #context_menu {
            position: fixed;
            display: none;
            width: 200px;
            border: solid;
            z-index: 40;
            background: inherit;
        }

            #context_menu > div {
                cursor: pointer;
            }
    </style>
</head>
<body>
    <div id="screenTest" style="width:100vw;height:100vh;visibility:hidden;z-index:-99"></div>

    <div id="navSwitch" onclick="NavSwitch()"></div>
    <div id="menu">

        <div id="navSwitchDummy" style="width:10vw;background:transparent;">TOC</div>
        <div style="border-right:solid 1px;">
            <div><input id="fontSizeInput" style="width:3em" type="number" />px</div>
            <div onclick="ApplyFontSize(document.getElementById('fontSizeInput').value)" style="cursor:pointer;background:white;font-size:0.7em">字号生效</div>
        </div>
        <div><div style="cursor:pointer;" onclick="Inspector()">检查</div></div>
        <div>
            <div style="top:3vh;line-height:1.2em;">
                Theme:　<br /><select id="themeSelect" onchange="SetTheme()">
                    <option value="default" selected>Default</option>
                    <option value="warm">Warm</option>
                    <option value="dark">Dark</option>
                </select>
            </div>
        </div>
        <div><div style="cursor:pointer;" onclick="ImageQuickView()">速览插图</div></div>
        <div><div style="cursor:pointer;" onclick="BookInfo()">书籍信息</div></div>
        <div><div style="cursor:pointer;" onclick="SearchService()">搜索</div></div>


    </div>
    <div id="sp_frame_general_container" class="sp_frame_container"><div class="sp_frame_close" onclick="document.CloseSpFrame()">Close</div><iframe id="sp_frame_general" class="sp_frame"></iframe></div>
    <div id="sp_frame_search_container" class="sp_frame_container"><div class="sp_frame_close" onclick="document.CloseSpFrame()">Close</div><iframe id="sp_frame_search" class="sp_frame"></iframe></div>
    <div id="nav" style=""></div>
    <div id="mouseListener" style="position:fixed;z-index:1;width:100vw;height:100vh;left:0;top:0;"></div>
    <div id="scrollBar_container" onmouseenter="ScrollBarMouseEnter(event)" onmouseleave="ScrollBarMouseLeave(event)" onmousemove="ScrollBarMouseMove(event)">
        <div id="scrollBarChapterDisplay" class="scrollBarChapterDisplay"><div class="scrollBarChapterName"></div></div>
    </div>
    <div id="context_menu"></div>
    <script>
        ScreenTest();

        var direction_rtl = new Object();
        direction_rtl.GetParallelLength = function (e) { return e.offsetWidth; }
        direction_rtl.SetParallelLength = function (e, px) { e.style.width = px + "px"; }
        direction_rtl.GetElementPos = function (e, f) { return f.contentWindow.document.documentElement.scrollWidth - e.getBoundingClientRect().right; }
        direction_rtl.GetWindowLength = function () { return window.innerWidth; }
        direction_rtl.AdjustFrameSize = function (f) { f.width = f.contentWindow.document.documentElement.scrollWidth + "px"; }
        direction_rtl.SetPosStyle = function (e) { e.style.right = e.pos + "px"; }
        direction_rtl.GetEventParallel = function (e) { return e.target.offsetWidth - e.x; }
        direction_rtl.GetEventParallelPercent = function (e) { return (e.target.offsetWidth - e.x) / e.target.offsetWidth; }
        direction_rtl.SetParallelPositivePos = function (e, px) { e.style.right = px + "px"; }
        direction_rtl.GetEffective = function (x, y) { return x; };
        direction_rtl.GetDelta = function (d1, d2) { return d1 - d2; };
        direction_rtl.KeyToDirection = function (k) {
            switch (k) {
                case "ArrowLeft": return -1;
                case "ArrowUp": return 1;
                case "ArrowRight": return 1;
                case "ArrowDown": return -1;
            }
            return 0;
        }
        direction_rtl.style = "\
iframe{height:90vh;top:2vh;}\
#scrollBar_container{width: 100vw;height:7vh; left: 0; bottom: 0; margin: 0;}\
#scrollBar{\
width: 100vw; left: 0; bottom: 0; margin: 0;margin-top:2vh;\
transform-origin: 50vw; transform: rotate(180deg); \
}\
#scrollBar::-webkit-slider-runnable-track{height:3vh;}\
#scrollBar::-webkit-slider-thumb{width: 15px;height: 3vh;}\
.scrollBarChapterDisplay{height:3vh;margin-top:2vh;}\
.scrollBarChapterName{margin-top:-1.5em;}\
";
        direction_rtl.injectStyle = "body{height:100vh;min-width:66vh;}";
        var direction_default = new Object();
        direction_default.GetParallelLength = function (e) { return e.offsetHeight; }
        direction_default.SetParallelLength = function (e, px) { e.style.height = px + "px"; }
        direction_default.GetElementPos = function (e, f) { return e.getBoundingClientRect().top; }
        direction_default.GetWindowLength = function () { return window.innerHeight; }
        direction_default.AdjustFrameSize = function (f) { f.height = f.contentWindow.document.documentElement.scrollHeight + "px"; }
        direction_default.SetPosStyle = function (e) { e.style.top = e.pos + "px"; }
        direction_default.GetEventParallel = function (e) { return e.y; }
        direction_default.GetEventParallelPercent = function (e) { return (e.y) / window.innerHeight; }//limited usage
        direction_default.SetParallelPositivePos = function (e, px) { e.style.top = px + "px"; }
        direction_default.GetEffective = function (x, y) { return y; };
        direction_default.GetDelta = function (d1, d2) { return d2 - d1; };
        direction_default.KeyToDirection = function (k) {
            switch (k) {
                case "ArrowUp": return 1;
                case "ArrowDown": return -1;
            }
            return 0;
        }
        direction_default.style = "\
iframe{width:92vw;left:4vw;min-height:90vh;} \
#scrollBar_container{width: 3vw;height:100vh; right: 0; bottom: 0; margin: 0;}\
#scrollBar{\
margin:0 0 0 3vw;\
width:100vh;height:3vw;\
transform-origin:top left;\
transform: rotate(90deg);\
}\
#scrollBar::-webkit-slider-runnable-track{width:3vh;}\
#scrollBar::-webkit-slider-thumb{width: 3vw;height: 3vh;}\
.scrollBarChapterDisplay{width:3vh;}\
.scrollBarChapterName{margin-left:-10em;width:10em;white-space:normal}\
";
        direction_default.injectStyle = "body{width:100vw;padding-bottom:3vh;}";


        var theme_default = new Object();
        theme_default.name = "default";
        theme_default.viewerStyle = "#nav,#menu{background:white;color:black;}.scrollBarChapterName {background:white;}";
        theme_default.frameStyle = "body{background:white;color:black;}";
        var warmColor = "";
        var theme_warm = new Object();
        function gen_theme_warm(_warmColor) {
            warmColor = _warmColor;
            theme_warm.name = "warm";
            theme_warm.viewerStyle = "body,#nav,#menu{background:{warm};color:black;}.scrollBarChapterName {background:{warm};}".replace(/{warm}/g, warmColor);
            theme_warm.frameStyle = "body{background:{warm};color:black;}".replace(/{warm}/g, warmColor);
        }

        var theme_dark = new Object();
        theme_dark.name = "dark";
        theme_dark.viewerStyle = "body,#nav,#menu{background:black;color:white;}.scrollBarChapterName{background:black;}";
        theme_dark.frameStyle = "body{background:black;color:white;}";

        document.theme = theme_default;
        var themeStyle = document.createElement("style");
        document.head.appendChild(themeStyle);
        var direction = direction_default;
        var frameList = new Array();
        var urlList;
        var directionStyle = document.createElement('style');
        document.head.appendChild(directionStyle);
        //////////Event////////
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.Wheel = function (event) { document.Scroll(Math.sign(event.wheelDelta) * 50); }
        document.getElementById("mouseListener").onmousewheel = function (e) {
            document.Wheel(e);
        }
        document.keydown = function (e) {
            if (e.ctrlKey) {
                switch (e.key) {
                    case "f": SearchService(); break;

                }
            } else {
                let d = direction.KeyToDirection(e.key);
                Scroll(d * 30);
            }

        };
        document.addEventListener("keydown", document.keydown);
        var PrepareResize = function () {
            window.removeEventListener("resize", PrepareResize)
            var xhttp = new XMLHttpRequest();
            xhttp.open("GET", "aeroepub://app/pos" + GetBookPos(), true);
            xhttp.send();
        };
        window.addEventListener("resize", PrepareResize);
        //////////Load/////////
        function Init(_urlList, start = 0, posRate = 0, selector = "") {
            document.direction = direction;
            console.log("Init start=" + start + " pos=" + posRate + " selector=" + selector);

            directionStyle.innerHTML = direction.style;

            urlList = _urlList;

            let page = CreateFrame(start, posRate, CheckLoad, false, true, selector);
            frameList.push(page);
        }

        function LoadTocNcx(data, path) {
            let nav = document.getElementById("nav");
            nav.innerHTML = data;
            let navPionts = nav.getElementsByTagName("navPoint");
            [].forEach.call(navPionts, function (p) {
                let label = p.getElementsByTagName("navLabel")[0];
                let content = p.getElementsByTagName("content")[0];
                label.onclick = function () {
                    Link(path + "/" + content.getAttribute("src"));
                    NavSwitch();
                    document.MenuClose();
                }
            });
        }
        function LoadTocNav(data, path) {
            let nav = document.getElementById("nav");
            nav.innerHTML = data;
            var checkchild = function (e) {
                if (e.getAttribute("hraf")) {
                    let p = path + "/" + e.getAttribute("hraf");
                    e.onclick = function () {
                        Link(p);
                        NavSwitch();
                        document.MenuClose();
                    }
                    e.removeAttribute("hraf");
                }
                [].forEach.call(e.children, checkchild);
            }
            checkchild(nav);

        }
        function LoadUserSettings(json) {
            document.userSettings = json;
            document.getElementById("fontSizeInput").value = json.bookFontSize;
            document.getElementById("themeSelect").value = json.viewerTheme;
            SetTheme();
        }
        ///↓Scroll Bar///
        var contentLengthData;
        var contentChapterData;
        var scrollBar;
        var scrollBar_container = document.getElementById("scrollBar_container");
        function LoadScrollBar(arr, plain) {
            contentLengthData = arr;
            contentChapterData = plain;
            //console.log(arr.length == plain.length);
            let total = 0;
            for (let i = 0; i < contentLengthData.length; i++)
                total += contentLengthData[i];
            scrollBar = document.createElement("input");
            scrollBar.id = "scrollBar";
            scrollBar.type = "range";
            scrollBar.min = 0;
            scrollBar.max = total;
            scrollBar.step = 1;
            scrollBar.oninput = function () {
            };
            scrollBar.onchange = function () {
                scrollBar.blur();
                let v = scrollBar.value;
                let s = 0;
                for (let i = 0; i < contentLengthData.length; i++) {
                    s += contentLengthData[i];
                    if (s >= v) {
                        let rate = (v - s + contentLengthData[i]) / contentLengthData[i];
                        frameList.forEach(e => e.parentNode.removeChild(e));
                        frameList = new Array();
                        Init(urlList, i, rate);
                        return;
                    }
                }
                console.log("DEBUG:shouldnt be here");
            };
            scrollBar_container.appendChild(scrollBar);

        }
        function SetScrollBar() {
            let v = 0;
            let i = 0;
            for (; i < currentFrame.urlIndex; i++)
                v += contentLengthData[i];

            v += (-currentFrame.pos) * contentLengthData[i] / direction.GetParallelLength(currentFrame);//i是urlIndex

            scrollBar.value = v;
        }
        var scrollBarFadeHandle = null;
        var scrollBarChapterDisplay = document.getElementById("scrollBarChapterDisplay");
        function ScrollBarMouseEnter(e) {
            clearTimeout(scrollBarFadeHandle);
            scrollBar_container.style.animation = "";
            scrollBar_container.style.opacity = "1";
        }
        function ScrollBarMouseLeave(e) {
            scrollBarFadeHandle = setTimeout(function () {
                scrollBar_container.style.animation = "fadeOut 0.5s ease 0s 1";
                scrollBar_container.style.animationFillMode = "forwards";
            }, 2000);
            scrollBarChapterDisplay.children[0].innerHTML = "";
            currentChapterName = "";
        }
        function ScrollBarMouseMove(e) {
            let p = direction.GetEventParallelPercent(e);
            ScrollBarChapterDisplay(p);
        }
        var currentChapterName = "";
        function ScrollBarChapterDisplay(p) {
            let pos = scrollBar.max * p;
            let chaptername = "";
            let chapterlength = 0;
            let chapterpos = 0;
            let templength = 0;
            let gotchapter = false;
            for (let i = 0; i < contentLengthData.length; i++) {
                if (contentChapterData[i] != "") {
                    if (gotchapter) break;
                    chaptername = contentChapterData[i];
                    chapterlength = 0;
                    chapterpos = templength;
                }
                chapterlength += contentLengthData[i];
                templength += contentLengthData[i];
                if (templength > pos) {
                    gotchapter = true;
                }
            }
            if (currentChapterName == "" || (currentChapterName != chaptername && currentChapterName != "")) {
                let pxmax = direction.GetParallelLength(scrollBar_container);
                direction.SetParallelPositivePos(scrollBarChapterDisplay, chapterpos / scrollBar.max * pxmax);
                direction.SetParallelLength(scrollBarChapterDisplay, chapterlength / scrollBar.max * pxmax);
                currentChapterName = chaptername;
                scrollBarChapterDisplay.children[0].innerHTML = chaptername;
            }

        }
        function ScrollBarShow() {
            clearTimeout(scrollBarFadeHandle);
            scrollBar_container.style.animation = "";
            scrollBar_container.style.opacity = "1";
            scrollBarFadeHandle = setTimeout(function () {
                scrollBar_container.style.animation = "fadeOut 0.5s ease 0s 1";
                scrollBar_container.style.animationFillMode = "forwards";
            }, 2000);
        }
        ///↓Nav///
        document.Link = Link;
        function Link(url, _selector = null) {
            let fullurl = url;
            if (fullurl.indexOf("/../") > 0) {
                let i = fullurl.indexOf("/../");
                let j = i;
                do {
                    j--;
                    if (j < 0) { console.log("error"); return; }
                } while (fullurl[j] != '/');
                fullurl = fullurl.substring(0, j) + fullurl.substring(i + 3);
            }
            if (fullurl.indexOf("aeroepub") != 0)
                fullurl = "aeroepub://" + ("book/" + fullurl).replace("//", "/");
            let split_temp = fullurl.split('#');
            let path = split_temp[0];
            let selector = null;
            if (_selector) selector = _selector;
            else if (split_temp.length > 1) selector = "#" + split_temp[1];

            console.log("Linkto:" + fullurl);
            for (var i = 0; i < urlList.length; i++) {

                if (urlList[i] == path) { DirectToIndex(i, selector); return; }

            }
            console.log("Cannot link to " + url);
        }
        function DirectToIndex(urlIndex, selector) {
            frameList.forEach(e => e.parentNode.removeChild(e));
            frameList = new Array();
            Init(urlList, urlIndex, 0, selector);
            ScrollBarShow();
        }
        ///↓Core Function///
        function CreateFrame(urlIndex, pos, check = null, addSelfLength = false, isPosRate = false, selector = null) {
            loading++;
            console.log("Create Frame " + urlList[urlIndex] + (isPosRate ? " posRate:" : " pos:") + pos + " addSelf:" + addSelfLength + " selector=" + selector);
            let page = document.createElement("iframe");
            //private use
            page.pos = pos;
            page.urlIndex = urlIndex;
            page.style.visibility = "hidden";
            if (urlIndex == 0) page.firstFrame = true; else page.firstFrame = false;
            if (urlIndex == urlList.length - 1) page.lastFrame = true; else page.lastFrame = false;

            page.scrolling = "no";
            page.frameBorder = "0";
            page.src = urlList[urlIndex];
            direction.SetPosStyle(page);
            page.onload = function () {
                direction.AdjustFrameSize(page);
                if (addSelfLength) {
                    page.pos = pos - direction.GetParallelLength(page);
                    direction.SetPosStyle(page);
                } else {
                    if (isPosRate) {
                        page.pos = -parseInt(pos * direction.GetParallelLength(page));
                    } else {
                        page.pos = pos;
                    }
                    direction.SetPosStyle(page);
                }
                if (selector) {
                    let t = page.contentDocument.querySelector(selector);
                    if (t) {
                        let ele_pos = direction.GetElementPos(t, page);
                        page.pos = -ele_pos + 10;
                        direction.SetPosStyle(page);
                    } else console.log('Query Failure:' + selector);
                }
                loading--;
                page.style.visibility = "visible";
                if (check != null) check();
                //Must scroll once to update current frame
                if (page.lastFrame) {
                    Scroll(-1);
                } else { Scroll(0); }
                SetScrollBar();
                page.onload = null;
            }
            document.body.appendChild(page);
            return page;
        }
        var currentFrame = null;
        function GetBookPos() {
            if (currentFrame == null) return "/0";
            return "/" + currentFrame.urlIndex + "/" + Math.floor(currentFrame.pos) + "/" + (direction.GetParallelLength(currentFrame));
        }
        document.Scroll = Scroll;
        function Scroll(px) {
            if (frameList[0].firstFrame && px > 0) {
                if (frameList[0].pos + px > 0) { px = - frameList[0].pos; }
            }
            let last = frameList[frameList.length - 1];
            if (last.lastFrame && px < 0) {
                if (last.pos + direction.GetParallelLength(last) + px < direction.GetWindowLength()) { px = direction.GetWindowLength() - last.pos - direction.GetParallelLength(last); }
            }
            currentFrame = frameList[0];
            let lastPos = px + frameList[0].pos;
            for (let i = 0; i < frameList.length; i++) {
                let e = frameList[i];
                e.pos = lastPos;
                direction.SetPosStyle(e);
                if (e.pos < 0 && e.pos + direction.GetParallelLength(e) > 0) { currentFrame = e; }
                lastPos = e.pos + direction.GetParallelLength(e);
            }
            if (!loading) CheckLoad();
            SetScrollBar();
        }
        var loading = 0;
        var offScreenDestoryDistance = 50;
        var preLoadDistance = 50;
        var checking = false;
        function CheckLoad() {
            if (checking) return;
            checking = true;
            CheckForward();
            CheckBackward();
            checking = false;
        }
        function CheckBackward() {
            let first = frameList[0];
            if (-first.pos < preLoadDistance) {
                if (!first.firstFrame) {
                    frameList.unshift(CreateFrame(first.urlIndex - 1, first.pos, CheckBackward, true));
                }
            }

            if (first.pos + direction.GetParallelLength(first) < -offScreenDestoryDistance) {
                first.parentNode.removeChild(first);
                frameList.shift();
            }
        }
        function CheckForward() {
            let last = frameList[frameList.length - 1];
            if (last.pos + direction.GetParallelLength(last) < direction.GetWindowLength() + preLoadDistance) {

                if (!last.lastFrame) {
                    frameList.push(CreateFrame(last.urlIndex + 1, last.pos + direction.GetParallelLength(last), CheckForward));
                }
            }

            if (last.pos > direction.GetWindowLength() + offScreenDestoryDistance) {
                last.parentNode.removeChild(last);
                frameList.pop();
                CheckLoad();
            }
        }
        function ScreenTest() {
            let e = document.getElementById("screenTest");
            AppCall("aeroepub://app/screentest/" + e.offsetWidth + "/" + e.offsetHeight);
        }
        /// Other UI///
        var nav = document.getElementById("nav");
        var navOn = false;
        function NavSwitch() {
            if (navOn) {
                navOn = false;
                nav.style.animation = "navHide 0.5s ease 0s 1 ";

            } else {
                navOn = true;
                nav.style.animation = "navDisplay 0.5s ease 0s 1";

            }
            nav.style.animationFillMode = "forwards";

        }
        var menuOn = false;
        var menu = document.getElementById("menu");

        document.MenuSwitch = function () {
            if (menuOn) {

                document.MenuClose();
            } else {
                document.MenuOpen();
            }

        };
        document.MenuClose = function () {
            menuOn = false;
            menu.style.animation = "menuHide 0.5s ease 0s 1 ";
            menu.style.animationFillMode = "forwards";
            if (navOn) { NavSwitch(); }
        };
        document.MenuOpen = function () {
            menuOn = true;
            menu.style.animation = "menuDisplay 0.5s ease 0s 1";
            menu.style.animationFillMode = "forwards";
        };
        function ApplyFontSize(a) {
            document.userSettings.bookFontSize = parseInt(a);
            AppCall("aeroepub://app/pos" + GetBookPos());
            AppCall("aeroepub://app/bookfontsize/" + document.userSettings.bookFontSize);
        }
        function Inspector() {
            AppCall("aeroepub://app/inspector");
        }
        var popupFootnote = null;
        document.PopupFootnote = function (content, left, top, frame) {
            if (popupFootnote != null) popupFootnote.parentNode.removeChild(popupFootnote);
            popupFootnote = document.createElement("div");
            popupFootnote.className = "popupFootnote";
            console.log(frame);
            document.body.appendChild(popupFootnote);
            left = frame.offsetLeft + left
            top = frame.offsetTop + top + 20;

            popupFootnote.innerHTML = content;
            if (left + popupFootnote.offsetWidth > window.innerWidth) {
                left = window.innerWidth - popupFootnote.offsetWidth;
            }
            console.log(top);
            if (top + popupFootnote.offsetHeight > window.innerHeight) {

                top = window.innerHeight - popupFootnote.offsetHeight;

            }
            popupFootnote.style.left = left + "px";
            popupFootnote.style.top = top + "px";
        }
        var PopupFootnote2 = function (content, left, top, frame) {
            if (popupFootnote != null) popupFootnote.parentNode.removeChild(popupFootnote);
            popupFootnote = document.createElement("iframe");
            popupFootnote.className = "popupFootnote";
            popupFootnote.src = frame.src + "?footnote";
            document.body.appendChild(popupFootnote);
            left = frame.offsetLeft + left
            top = frame.offsetTop + top + 20;

            popupFootnote.onload = function () {
                let styles = '';
                [].forEach.call(frame.contentWindow.document.head.querySelectorAll('style'), function (e) { styles += e.outerHTML; });
                popupFootnote.contentWindow.document.documentElement.innerHTML = "<head>" + styles + "</head><body style='margin:3%;width:94%'>" + content + "</body>";
                if (left + popupFootnote.offsetWidth > window.innerWidth) {
                    left = window.innerWidth - popupFootnote.offsetWidth;
                }
                if (top + popupFootnote.offsetHeight > window.innerHeight) {
                    top = window.innerHeight - popupFootnote.offsetHeight;
                }
                popupFootnote.style.left = left + "px";
                popupFootnote.style.top = top + "px";
                popupFootnote.contentWindow.document.addEventListener('contextmenu', event => event.preventDefault());
            }
            menuOn = false;
            menu.style.animation = "";

        }
        document.TryCloseFootnote = function () {
            if (popupFootnote != null) {
                popupFootnote.parentNode.removeChild(popupFootnote);
                popupFootnote = null;
                return true;
            }
            return false;
        }

        document.PopupFootnote = PopupFootnote2;
        ///////menu
        var contextMenu = document.getElementById("context_menu");
        var contextMenuOn = false;
        var tempTargetElement = null;
        document.ContextMenu = function (e, left, top, frame) {
            tempTargetElement = e;
            contextMenuOn = true;
            left = frame.offsetLeft + left;
            top = frame.offsetTop + top;
            contextMenu.style.left = left + "px";
            contextMenu.style.top = top + "px";
            contextMenu.style.display = "block";
            let inner = "<div onclick=\"InspectElement()\">检查元素</div>";
            if (e.tagName == "IMG") {
                inner += "<div onclick=\"CopyImage('" + e.src + "')\">复制图片</div>";
            }
            if (e.tagName.toUpperCase() == "IMAGE") {
                inner += "<div onclick=\"CopyImage('" + ReferPath(frame.src, e.getAttribute("xlink:href")) + "')\">复制图片</div>";
            }
            contextMenu.innerHTML = inner;
        }
        document.TryCloseContextMenu = function () {
            if (contextMenuOn) {
                contextMenu.style.display = "none";
                contextMenuOn = false;
                return true;
            }
            return false;
        }
        function CopyImage(url) {
            AppCall("aeroepub://app/CopyImage/" + url.substring("aeroepub://book/".length));
            document.TryCloseContextMenu();
        }
        function InspectElement() {
            console.log(tempTargetElement);
            Inspector();
            document.TryCloseContextMenu();
        }
        var touchPos = -1;
        document.OnFrameTouchStart = function (x, y) {
            touchPos = direction.GetEffective(x, y);
        };
        document.OnFrameTouchMove = function (x, y) {
            let d = direction.GetEffective(x, y);
            let delta = direction.GetDelta(touchPos, d);
            Scroll(delta);
            touchPos = d;
        };
        document.OnFrameTouchEnd = function () {
            touchPos = -1;
        };
        function SetTheme() {
            let name = document.getElementById("themeSelect").value;
            gen_theme_warm(document.userSettings.warmColor);
            switch (name) { case "default": document.theme = theme_default; break; case "warm": document.theme = theme_warm; break; case "dark": document.theme = theme_dark; break; }
            for (let i = 0; i < frameList.length; i++) { frameList[i].contentWindow.location.reload(); }
            themeStyle.innerHTML = document.theme.viewerStyle;
            AppCall("aeroepub://app/theme/" + name);
        }

        ///SP Frame//
        var sp_frame_c = document.getElementById('sp_frame_general_container');
        var sp_frame = document.getElementById('sp_frame_general');
        var sp_page_scroll = 100;
        document.CloseSpFrame = function () {
            sp_page_scroll = sp_frame.contentDocument.scrollingElement.scrollTop;
            sp_frame_c.style.display = 'none';
            document.getElementById('sp_frame_search_container').style.display = 'none';
            console.log(sp_page_scroll)
        }

        function ImageQuickView() {
            document.MenuClose();
            sp_frame_c.style.display = "block";
            if (sp_frame.src != "aeroepub://app/ImageQuickView") {
                sp_frame.src = "aeroepub://app/ImageQuickView";
                sp_page_scroll = 0;
            }
            sp_frame.contentDocument.scrollingElement.scrollTop = sp_page_scroll;
        }
        function BookInfo() {
            document.MenuClose();

            sp_frame_c.style.display = "block";
            sp_frame.src = "aeroepub://app/BookInfo"
        }
        var search_frame_c = document.getElementById('sp_frame_search_container');
        var search_frame = document.getElementById('sp_frame_search');
        var search_page_init = false;
        var search_page_scroll = 0;
        function SearchService() {
            document.MenuClose();

            search_frame_c.style.display = "block";
            if (!search_page_init) {
                search_frame.onload = function () { search_frame.contentWindow.document.getElementById("search_input").focus(); }
                search_frame.src = "aeroepub://viewer/search-service.html";
            } else {
                search_frame.contentWindow.document.getElementById("search_input").focus();
            }
            search_page_init = true;

        }
        ///////////util
        function AppCall(url) {
            let xhttp = null
            xhttp = new XMLHttpRequest();
            xhttp.open("GET", url, true);
            xhttp.send();
        }
        function ReferPath(file, href) {
            file = file.substr(0, file.lastIndexOf('/'));
            while (href.startsWith("..")) {
                href = href.substr(3);
                file = file.substr(0, file.lastIndexOf('/'));
            }
            let s = "";
            if (href[0] != '/' && file[file.length] != '/') s = "/";
            return file + s + href;
        }
    </script>
</body>

</html>